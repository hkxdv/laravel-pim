# ====================================================================
# Configuración para protección de assets estáticos en Nginx
# ====================================================================

# Permitir acceso a symlink de Laravel: /public/storage -> storage/app/public
# Usamos ^~ para que tenga prioridad sobre los bloques regex (~, ~*)
location ^~ /storage/ {
    # Desactivar listado de directorios
    autoindex off;
    # Intentar servir el archivo; si no existe, 404
    try_files $uri $uri/ =404;
    access_log off;
}

# Configuración de caché para recursos estáticos
# Caché agresiva para tipografías y assets versionados
location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc|woff2|woff|ttf|eot)$ {
    expires 1M;
    access_log off;

}

# Caché más agresiva para assets versionados (con hash en nombre)
location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc|woff2|woff|ttf|eot)\?[a-f0-9]+$ {
    expires max;
    access_log off;
    add_header Cache-Control "public, immutable";
}


# Bloquear acceso a archivos sensibles
location ~* (\.(?:git|htaccess|env|env\..*|config|config\..*|example|dist|bak|swp|yaml|yml|twig|md|log|json|lock|txt|sql))$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Bloquear acceso a directorios sensibles (excluimos /storage porque ya está permitido arriba)
location ~* /(vendor|node_modules|tests|database|config|resources/lang|resources/views)/ {
    deny all;
    access_log off;
    log_not_found off;
}

# Bloquear acceso a archivos de configuración de IDE
location ~* /\.(?:idea|vscode|editorconfig)/ {
    deny all;
    access_log off;
    log_not_found off;
}

# Bloquear acceso a archivos de configuración de paquetes
location ~* /(composer\.json|composer\.lock|package\.json|package-lock\.json|yarn\.lock)$ {
    deny all;
    access_log off;
    log_not_found off;
}