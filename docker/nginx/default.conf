# ====================================================================
# Configuración de Nginx para la aplicación Laravel + Vite
# ====================================================================
# - Configuración optimizada para trabajar como proxy reverso para PHP-FPM
# - Incluye configuraciones de seguridad (headers, protección de assets)
# - Manejo de conexiones WebSocket para Vite HMR en desarrollo
# - Reglas para servir assets estáticos y manejar rutas de Laravel
# ====================================================================

server {
    # Puerto de escucha (no privilegiado para usuario no-root)
    listen 8080;
    server_name localhost;
    root /var/www/backend/public;

    # Headers de seguridad
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
    # Content-Security-Policy Relajada para desarrollo.
    # Permite cualquier fuente para facilitar la configuración inicial (No usar en producción final).
    add_header Content-Security-Policy "default-src * 'unsafe-inline' 'unsafe-eval' data: blob: ws:; script-src * 'unsafe-inline' 'unsafe-eval' data: blob:; connect-src * 'unsafe-inline' 'unsafe-eval' data: blob: ws:; style-src * 'unsafe-inline'; img-src * data: blob:; font-src * data: blob:;" always;

    # Incluir reglas de protección de assets (snippet)
    include /etc/nginx/snippets/protect-assets.conf;

    # Archivo índice por defecto
    index index.php;

    # Codificación UTF-8
    charset utf-8;

    # Proxy para Vite en desarrollo
    # Este bloque intercepta solicitudes a archivos de módulos y las envía al servidor de desarrollo de Vite
    location ~ ^/(node_modules|@vite|src|.*\.tsx|.*\.ts|.*\.jsx|.*\.js)$ {
        proxy_pass http://host.docker.internal:5173;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_http_version      1.1;
        proxy_set_header        Upgrade $http_upgrade;
        proxy_set_header        Connection "Upgrade";
    }

    # Configuración para assets de Vite (producción)
    # Agrega cache-control para optimizar la carga de assets
    location /build {
        add_header Cache-Control "public, max-age=31536000, immutable";
        try_files $uri =404;
    }

    # Ruta principal - maneja el enrutamiento SPA/Laravel
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # No logear accesos a favicon y robots.txt
    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    # Página de error 404 por defecto
    error_page 404 /index.php;

    # Procesamiento de PHP con PHP-FPM
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass backend:9000;    # Apunta al servicio 'backend' definido en docker-compose
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # Bloquea acceso a archivos ocultos excepto .well-known
    location ~ /\.(?!well-known).* {
        deny all;
    }

    # Endpoint simple de healthcheck
    location = /ping {
        return 200 'ok';
        add_header Content-Type text/plain;
    }
}
