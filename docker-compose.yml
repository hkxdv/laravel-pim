services:
    # Servicio Backend (Laravel + PHP-FPM)
    backend:
        build:
            context: .
            dockerfile: docker/php/Dockerfile
        container_name: laravel-pim-backend
        working_dir: /var/www/backend
        environment:
            APP_NAME: ${APP_NAME}
            APP_ENV: ${APP_ENV}
            APP_KEY: ${APP_KEY}
            APP_DEBUG: ${APP_DEBUG}
            APP_URL: ${APP_URL}
            FRONTEND_URL: ${FRONTEND_URL}
            APP_RUNNING_IN_CONTAINER: ${APP_RUNNING_IN_CONTAINER}
            SANCTUM_STATEFUL_DOMAINS: ${SANCTUM_STATEFUL_DOMAINS}
            SESSION_DRIVER: ${SESSION_DRIVER}
            SESSION_DOMAIN: ${SESSION_DOMAIN}
            SESSION_LIFETIME: ${SESSION_LIFETIME}
            SESSION_SAME_SITE: ${SESSION_SAME_SITE}
            SESSION_SECURE_COOKIE: ${SESSION_SECURE_COOKIE}
            QUEUE_CONNECTION: ${QUEUE_CONNECTION}
            LOG_CHANNEL: ${LOG_CHANNEL}
            LOG_LEVEL: ${LOG_LEVEL}
            LOG_DEPRECATIONS_CHANNEL: ${LOG_DEPRECATIONS_CHANNEL}
            FORCE_HTTPS: ${FORCE_HTTPS}
            DB_CONNECTION: ${DB_CONNECTION}
            DB_HOST: ${DB_HOST}
            DB_PORT: ${DB_PORT}
            DB_DATABASE: ${DB_DATABASE}
            DB_USERNAME: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}
            SEARCH_MODE: ${SEARCH_MODE}
            SCOUT_DRIVER: ${SCOUT_DRIVER}
            TYPESENSE_HOST: ${TYPESENSE_HOST}
            TYPESENSE_PORT: ${TYPESENSE_PORT}
            TYPESENSE_PROTOCOL: ${TYPESENSE_PROTOCOL}
            TYPESENSE_API_KEY: ${TYPESENSE_API_KEY}
            TYPESENSE_PATH: ${TYPESENSE_PATH}
        volumes:
            - ./.env.users:/var/www/backend/.env.users
        networks:
            - laravel-pim-network
        depends_on:
            db:
                condition: service_healthy
            typesense:
                condition: service_healthy
        healthcheck:
            test: ["CMD-SHELL", "cgi-fcgi -connect 127.0.0.1:9000 /ping || exit 1"]
            interval: 15s
            timeout: 5s
            retries: 5
            start_period: 10s
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        deploy:
            resources:
                limits:
                    cpus: "1.0"
                    memory: "1G"
                reservations:
                    memory: "256M"
        restart: unless-stopped

    # Servicio Nginx (Servidor web)
    nginx:
        build:
            context: ./docker/nginx
            dockerfile: Dockerfile
        container_name: laravel-pim-nginx
        ports:
            - "8080:8080"
        volumes:
            - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
            - ./docker/nginx/snippets/protect-assets.conf:/etc/nginx/snippets/protect-assets.conf
            - ./backend:/var/www/backend:ro
        depends_on:
            backend:
                condition: service_healthy
        networks:
            - laravel-pim-network
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        deploy:
            resources:
                limits:
                    cpus: "0.50"
                    memory: "256M"
                reservations:
                    memory: "64M"
        restart: unless-stopped

    # Servicio de Base de Datos (PostgreSQL)
    db:
        build:
            context: .
            dockerfile: docker/postgres/Dockerfile
        container_name: laravel-pim-db
        ports:
            - "5432:5432"
        environment:
            POSTGRES_DB: ${DB_DATABASE}
            POSTGRES_USER: ${DB_USERNAME}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
        volumes:
            - db-data:/var/lib/postgresql/data
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    'pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB" -h 127.0.0.1 -p 5432',
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        networks:
            - laravel-pim-network
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        deploy:
            resources:
                limits:
                    cpus: "1.0"
                    memory: "1G"
                reservations:
                    memory: "256M"
        restart: unless-stopped

    # Servicio de búsqueda (Typesense)
    typesense:
        build:
            context: ./docker/typesense
            dockerfile: Dockerfile
        container_name: laravel-pim-typesense
        ports:
            - "8108:8108"
        environment:
            GLOG_minloglevel: "1"
        command:
            [
                "typesense-server",
                "--data-dir",
                "/data",
                "--api-key",
                "${TYPESENSE_API_KEY}",
                "--enable-cors",
                "true",
                "--listen-port",
                "8108",
                "--address",
                "0.0.0.0",
            ]
        volumes:
            - typesense-data:/data
        networks:
            - laravel-pim-network
        healthcheck:
            test: ["CMD-SHELL", "curl -sf http://localhost:8108/health || exit 1"]
            interval: 15s
            timeout: 5s
            retries: 5
            start_period: 10s
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        deploy:
            resources:
                limits:
                    cpus: "0.50"
                    memory: "512M"
                reservations:
                    memory: "128M"
        restart: unless-stopped

# Configuración de redes
networks:
    laravel-pim-network:
        driver: bridge

# Volúmenes persistentes
volumes:
    db-data:
        driver: local
    typesense-data:
        driver: local
